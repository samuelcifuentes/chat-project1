(()=>{"use strict";var e={56:(e,n,t)=>{e.exports=function(e){var n=t.nc;n&&e.setAttribute("nonce",n)}},72:e=>{var n=[];function t(e){for(var t=-1,r=0;r<n.length;r++)if(n[r].identifier===e){t=r;break}return t}function r(e,r){for(var o={},i=[],d=0;d<e.length;d++){var s=e[d],c=r.base?s[0]+r.base:s[0],u=o[c]||0,l="".concat(c," ").concat(u);o[c]=u+1;var p=t(l),m={css:s[1],media:s[2],sourceMap:s[3],supports:s[4],layer:s[5]};if(-1!==p)n[p].references++,n[p].updater(m);else{var f=a(m,r);r.byIndex=d,n.splice(d,0,{identifier:l,updater:f,references:1})}i.push(l)}return i}function a(e,n){var t=n.domAPI(n);return t.update(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap&&n.supports===e.supports&&n.layer===e.layer)return;t.update(e=n)}else t.remove()}}e.exports=function(e,a){var o=r(e=e||[],a=a||{});return function(e){e=e||[];for(var i=0;i<o.length;i++){var d=t(o[i]);n[d].references--}for(var s=r(e,a),c=0;c<o.length;c++){var u=t(o[c]);0===n[u].references&&(n[u].updater(),n.splice(u,1))}o=s}}},113:e=>{e.exports=function(e,n){if(n.styleSheet)n.styleSheet.cssText=e;else{for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(document.createTextNode(e))}}},208:(e,n,t)=>{t.d(n,{A:()=>d});var r=t(601),a=t.n(r),o=t(314),i=t.n(o)()(a());i.push([e.id,":root {\n    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n    color: #0b1f33;\n    background: linear-gradient(135deg, #f5f7fb, #eef2ff);\n    min-height: 100vh;\n}\n\nbody {\n    margin: 0;\n    padding: 2rem;\n}\n\n#app {\n    max-width: 1200px;\n    margin: 0 auto;\n}\n\n.layout {\n    display: grid;\n    grid-template-columns: 320px 1fr;\n    gap: 1.5rem;\n}\n\n.panel {\n    background: #fff;\n    border-radius: 16px;\n    padding: 1.5rem;\n    box-shadow: 0 10px 25px rgba(15, 34, 58, 0.08);\n}\n\n.panel h2 {\n    margin-top: 0;\n    font-size: 1.2rem;\n    font-weight: 600;\n}\n\ninput,\ntextarea,\nselect,\nbutton {\n    width: 100%;\n    padding: 0.75rem 1rem;\n    border-radius: 12px;\n    border: 1px solid #dbe4ff;\n    font-family: inherit;\n    font-size: 0.95rem;\n    box-sizing: border-box;\n    margin-bottom: 0.75rem;\n}\n\nbutton {\n    border: none;\n    background: linear-gradient(135deg, #4f46e5, #7c3aed);\n    color: #fff;\n    font-weight: 600;\n    cursor: pointer;\n    transition: transform 0.2s ease, box-shadow 0.2s ease;\n}\n\nbutton:hover {\n    transform: translateY(-1px);\n    box-shadow: 0 15px 30px rgba(76, 29, 149, 0.25);\n}\n\n.status-chip {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.35rem;\n    border-radius: 999px;\n    padding: 0.2rem 0.85rem;\n    font-size: 0.85rem;\n    background: #eef2ff;\n    color: #4338ca;\n    font-weight: 500;\n}\n\n.history {\n    height: 520px;\n    overflow-y: auto;\n    padding-right: 0.5rem;\n}\n\n.message {\n    padding: 0.75rem 1rem;\n    border-radius: 12px;\n    margin-bottom: 0.75rem;\n    background: #f8fafc;\n    border: 1px solid #e2e8f0;\n}\n\n.message.me {\n    background: #ede9fe;\n    border-color: #ddd6fe;\n}\n\n.message header {\n    display: flex;\n    justify-content: space-between;\n    font-size: 0.8rem;\n    margin-bottom: 0.4rem;\n    color: #475569;\n}\n\n.message p {\n    margin: 0;\n}\n\n.target-selector {\n    display: grid;\n    grid-template-columns: repeat(2, minmax(0, 1fr));\n    gap: 0.5rem;\n}\n\n.audio-controls {\n    display: flex;\n    gap: 0.5rem;\n}\n\n.audio-upload input[type=\"file\"] {\n    flex: 1;\n    border: 1px dashed #cbd5ff;\n    padding: 0.4rem;\n    border-radius: 12px;\n    background: #f8fafc;\n}\n\n.audio-upload {\n    flex-wrap: wrap;\n}\n\n.audio-upload button {\n    flex: 0 0 150px;\n}\n\n.notification {\n    background: #dff5ed;\n    border: 1px solid #a7f3d0;\n    color: #047857;\n    padding: 0.65rem 1rem;\n    border-radius: 12px;\n    margin-bottom: 0.75rem;\n    font-size: 0.9rem;\n}\n\n@media (max-width: 960px) {\n    .layout {\n        grid-template-columns: 1fr;\n    }\n}\n\n",""]);const d=i},314:e=>{e.exports=function(e){var n=[];return n.toString=function(){return this.map(function(n){var t="",r=void 0!==n[5];return n[4]&&(t+="@supports (".concat(n[4],") {")),n[2]&&(t+="@media ".concat(n[2]," {")),r&&(t+="@layer".concat(n[5].length>0?" ".concat(n[5]):""," {")),t+=e(n),r&&(t+="}"),n[2]&&(t+="}"),n[4]&&(t+="}"),t}).join("")},n.i=function(e,t,r,a,o){"string"==typeof e&&(e=[[null,e,void 0]]);var i={};if(r)for(var d=0;d<this.length;d++){var s=this[d][0];null!=s&&(i[s]=!0)}for(var c=0;c<e.length;c++){var u=[].concat(e[c]);r&&i[u[0]]||(void 0!==o&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=o),t&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=t):u[2]=t),a&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=a):u[4]="".concat(a)),n.push(u))}},n}},540:e=>{e.exports=function(e){var n=document.createElement("style");return e.setAttributes(n,e.attributes),e.insert(n,e.options),n}},601:e=>{e.exports=function(e){return e[1]}},659:e=>{var n={};e.exports=function(e,t){var r=function(e){if(void 0===n[e]){var t=document.querySelector(e);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(e){t=null}n[e]=t}return n[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(t)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var n=e.insertStyleElement(e);return{update:function(t){!function(e,n,t){var r="";t.supports&&(r+="@supports (".concat(t.supports,") {")),t.media&&(r+="@media ".concat(t.media," {"));var a=void 0!==t.layer;a&&(r+="@layer".concat(t.layer.length>0?" ".concat(t.layer):""," {")),r+=t.css,a&&(r+="}"),t.media&&(r+="}"),t.supports&&(r+="}");var o=t.sourceMap;o&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),n.styleTagTransform(r,e,n.options)}(n,e,t)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)}}}}},n={};function t(r){var a=n[r];if(void 0!==a)return a.exports;var o=n[r]={id:r,exports:{}};return e[r](o,o.exports,t),o.exports}t.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},t.d=(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},t.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),t.nc=void 0;var r=t(72),a=t.n(r),o=t(825),i=t.n(o),d=t(659),s=t.n(d),c=t(56),u=t.n(c),l=t(540),p=t.n(l),m=t(113),f=t.n(m),g=t(208),y={};y.styleTagTransform=f(),y.setAttributes=u(),y.insert=s().bind(null,"head"),y.domAPI=i(),y.insertStyleElement=p(),a()(g.A,y),g.A&&g.A.locals&&g.A.locals;const h={communicator:null,adapter:null,chatPrx:null,pushProxy:null,user:null,activeTarget:{id:"",type:"user"},groups:new Map,history:[],recorder:null,audioChunks:[],notifications:[],pendingAudioFile:null},v={};async function b(){if(!h.chatPrx)return void $("La conexi贸n con Ice no est谩 lista todav铆a.");const e=v.displayName.value.trim();try{const n=await h.chatPrx.registerUser(e);h.user=n,v.statusChip.textContent=`Conectado como ${n.displayName}`,await async function(){if(!h.user)return;class e extends Chat.RealtimePush{async onIncomingMessage(e){!function(e){const n=T();e.to===n.id&&e.toType===n.type||"user"===e.toType&&e.from===n.id&&"user"===n.type?(h.history.push(e),w()):$(`Nuevo mensaje de ${e.fromName}`)}(e)}async onGroupCreated(e){!function(e){h.groups.set(e.id,e),B(),$(`Se cre贸 el grupo ${e.name}`)}(e)}async onCallEvent(e){!function(e){$("start"===e.type?`${e.fromName} inici贸 una llamada`:`${e.fromName} finaliz贸 la llamada`)}(e)}}const n="undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`client-${Date.now()}`,t=Ice.generateUUID?Ice.generateUUID():n,r=Ice.stringToIdentity(t),a=new e;h.adapter.add(a,r);const o=Chat.RealtimePushPrx.uncheckedCast(h.adapter.createProxy(r));await h.chatPrx.subscribePush(h.user.id,o),h.pushProxy=o}(),$(`Bienvenido ${n.displayName}. Tu ID es ${n.id}`)}catch(e){F("No se pudo registrar",e)}}async function x(){if(!h.user)return void $("Registra un usuario antes de crear grupos.");const e=v.groupName.value.trim()||"Grupo sin nombre",n=v.groupMembers.value.split(",").map(e=>e.trim()).filter(Boolean);try{const t=await h.chatPrx.createGroup(h.user.id,e,n);h.groups.set(t.id,t),B(),$(`Grupo ${t.name} creado (${t.id})`)}catch(e){F("No se pudo crear el grupo",e)}}function B(){const e=Array.from(h.groups.values());e.length?v.groupList.innerHTML=e.map(e=>`\n            <div class="message">\n                <header>\n                    <strong>${e.name}</strong>\n                    <small>${e.id}</small>\n                </header>\n                <p>${e.members.length} miembros</p>\n                <button data-group="${e.id}">Abrir chat</button>\n            </div>\n        `).join(""):v.groupList.innerHTML="<p>No hay grupos a煤n.</p>"}async function I(){if(E())try{const{id:e,type:n}=T(),t=await h.chatPrx.getHistory(h.user.id,e,n);h.history=t,w()}catch(e){F("Error al recuperar historial",e)}}function w(){h.history.length?(v.history.innerHTML=h.history.map(e=>function(e){const n=h.user&&e.from===h.user.id,t=new Date(Number(e.timestamp)).toLocaleTimeString();let r="";return"text"===e.kind?r=`<p>${e.text}</p>`:"audio"===e.kind&&(r=`<audio controls src="${e.mediaPath}"></audio>`),`\n        <div class="message ${n?"me":""}">\n            <header>\n                <span>${e.fromName}</span>\n                <span>${t}</span>\n            </header>\n            ${r}\n        </div>\n    `}(e)).join(""),v.history.scrollTop=v.history.scrollHeight):v.history.innerHTML="<p>No hay mensajes todav铆a.</p>"}async function C(){if(!E())return;const e=v.messageInput.value.trim();if(e)try{const{id:n,type:t}=T();await h.chatPrx.sendText(h.user.id,n,t,e),v.messageInput.value=""}catch(e){F("No se pudo enviar",e)}}function E(){if(!h.user)return $("Primero registra un usuario."),!1;const e=v.targetId.value.trim(),n=v.targetType.value;return e?(h.activeTarget={id:e,type:n},!0):($("Selecciona un destino."),!1)}function T(){return{id:v.targetId.value.trim(),type:v.targetType.value}}async function N(){if(E())if(navigator.mediaDevices)try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});h.recorder=new MediaRecorder(e),h.audioChunks=[],h.recorder.ondataavailable=e=>{e.data.size>0&&h.audioChunks.push(e.data)},h.recorder.onstop=k,h.recorder.start(),v.recordBtn.disabled=!0,v.stopRecordBtn.disabled=!1,$("Grabando audio...")}catch(e){$(`No se pudo acceder al micr贸fono: ${e.message}`)}else $("El navegador no soporta MediaRecorder.")}function A(){h.recorder&&(h.recorder.stop(),v.recordBtn.disabled=!1,v.stopRecordBtn.disabled=!0,$("Grabaci贸n detenida, enviando..."))}async function k(){const e=new Blob(h.audioChunks,{type:"audio/webm"}),n=await e.arrayBuffer(),{id:t,type:r}=T();try{await h.chatPrx.sendAudio(h.user.id,t,r,new Uint8Array(n),e.type||"audio/webm"),$("Nota de voz enviada.")}catch(e){F("Error enviando audio",e)}}function L(e){const[n]=e.target.files;h.pendingAudioFile=n||null,v.sendAudioFileBtn.disabled=!h.pendingAudioFile,n&&$(`Nota seleccionada: ${n.name}`)}async function P(){if(E())if(h.pendingAudioFile)try{const e=await h.pendingAudioFile.arrayBuffer(),{id:n,type:t}=T();await h.chatPrx.sendAudio(h.user.id,n,t,new Uint8Array(e),h.pendingAudioFile.type||"audio/webm"),$("Nota de voz enviada."),h.pendingAudioFile=null,v.audioFileInput.value="",v.sendAudioFileBtn.disabled=!0}catch(e){F("Error enviando audio",e)}else $("Selecciona un archivo de audio.")}async function M(e){if(!E())return;const{id:n,type:t}=T();try{"start"===e?(await h.chatPrx.startCall(h.user.id,n,t),v.startCallBtn.disabled=!0,v.endCallBtn.disabled=!1):(await h.chatPrx.endCall(h.user.id,n,t),v.startCallBtn.disabled=!1,v.endCallBtn.disabled=!0)}catch(e){F("Error con la llamada",e)}}function $(e,n){const t=document.createElement("div");t.className="notification",t.textContent=e,v.notifications.prepend(t),setTimeout(()=>t.remove(),6e3)}function F(e,n){const t=function(e){if(!e)return"desconocido";if("string"==typeof e)return e;if(e.message)return e.message;if(e.ice_name)return e.ice_name;if(e.toString)return e.toString();try{return JSON.stringify(e)}catch(e){return"sin detalles"}}(n);console.error(e,n),$(`${e}: ${t}`)}document.addEventListener("DOMContentLoaded",async()=>{document.getElementById("app").innerHTML='\n        <div class="layout">\n            <div class="panel" id="sessionPanel">\n                <h2>Sesi贸n</h2>\n                <span id="statusChip" class="status-chip">Desconectado</span>\n                <input id="displayName" type="text" placeholder="Nombre visible" />\n                <button id="registerBtn">Registrar usuario</button>\n                <hr />\n                <h2>Grupo</h2>\n                <input id="groupName" type="text" placeholder="Nombre del grupo" />\n                <input id="groupMembers" type="text" placeholder="Miembros (IDs separados por coma)" />\n                <button id="createGroupBtn">Crear grupo</button>\n                <div id="groupList"></div>\n            </div>\n            <div class="panel">\n                <h2>Chat en tiempo real</h2>\n                <div id="notifications"></div>\n                <div class="target-selector">\n                    <select id="targetType">\n                        <option value="user">Usuario</option>\n                        <option value="group">Grupo</option>\n                    </select>\n                    <input id="targetId" type="text" placeholder="ID de destino" />\n                </div>\n                <button id="loadHistoryBtn">Ver historial</button>\n                <div class="history" id="history"></div>\n                <textarea id="messageInput" rows="3" placeholder="Escribe un mensaje..."></textarea>\n                <button id="sendTextBtn">Enviar texto</button>\n                <div class="audio-controls">\n                    <button id="recordBtn"> Grabar</button>\n                    <button id="stopRecordBtn" disabled>Detener</button>\n                </div>\n                <div class="audio-controls audio-upload">\n                    <input id="audioFileInput" type="file" accept="audio/*" />\n                    <button id="sendAudioFileBtn" disabled>Enviar nota</button>\n                </div>\n                <div class="audio-controls">\n                    <button id="startCallBtn">Iniciar llamada</button>\n                    <button id="endCallBtn" disabled>Finalizar llamada</button>\n                </div>\n            </div>\n        </div>\n    ',v.displayName=document.getElementById("displayName"),v.registerBtn=document.getElementById("registerBtn"),v.statusChip=document.getElementById("statusChip"),v.groupName=document.getElementById("groupName"),v.groupMembers=document.getElementById("groupMembers"),v.createGroupBtn=document.getElementById("createGroupBtn"),v.groupList=document.getElementById("groupList"),v.targetType=document.getElementById("targetType"),v.targetId=document.getElementById("targetId"),v.loadHistoryBtn=document.getElementById("loadHistoryBtn"),v.history=document.getElementById("history"),v.messageInput=document.getElementById("messageInput"),v.sendTextBtn=document.getElementById("sendTextBtn"),v.recordBtn=document.getElementById("recordBtn"),v.stopRecordBtn=document.getElementById("stopRecordBtn"),v.audioFileInput=document.getElementById("audioFileInput"),v.sendAudioFileBtn=document.getElementById("sendAudioFileBtn"),v.startCallBtn=document.getElementById("startCallBtn"),v.endCallBtn=document.getElementById("endCallBtn"),v.notifications=document.getElementById("notifications"),v.registerBtn.addEventListener("click",b),v.createGroupBtn.addEventListener("click",x),v.groupList.addEventListener("click",e=>{const n=e.target.closest("button[data-group]");var t,r;n&&(t=n.dataset.group,r="group",h.activeTarget={id:t,type:r},v.targetId.value=t,v.targetType.value=r,$(`Objetivo activo: ${t} (${r})`),I())}),v.loadHistoryBtn.addEventListener("click",I),v.sendTextBtn.addEventListener("click",C),v.recordBtn.addEventListener("click",N),v.stopRecordBtn.addEventListener("click",A),v.audioFileInput.addEventListener("change",L),v.sendAudioFileBtn.addEventListener("click",P),v.startCallBtn.addEventListener("click",()=>M("start")),v.endCallBtn.addEventListener("click",()=>M("end")),await async function(){if(!window.Ice)return void $("No se pudo cargar Ice.js desde la CDN.");if(!window.Chat)return void $("Genera el archivo ice/Chat.js con slice2js antes de continuar.");h.communicator=Ice.initialize(["Ice.ACM.Client=0","Ice.Trace.Network=0","Ice.RetryIntervals=-1","Ice.Default.Protocol=ws"]);const e=h.communicator.stringToProxy("ChatSession:ws -h localhost -p 10000");h.chatPrx=await Chat.ChatSessionPrx.checkedCast(e),h.adapter=await h.communicator.createObjectAdapter(""),"function"==typeof h.adapter.activate&&await h.adapter.activate(),v.statusChip.textContent="Ice listo"}()})})();